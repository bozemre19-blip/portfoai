          </div>
          <div className="flex-shrink-0 flex flex-col sm:items-end gap-2 w-full sm:w-auto">
            <div className="flex gap-2 w-full sm:w-auto">
              <button onClick={() => onAddObservation(data.id)} className="w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 bg-primary text-white rounded-md shadow-sm hover:bg-primary/90 transition-colors">
                <PlusIcon className="w-5 h-5" /> Gozlem Ekle
              </button>
              <button onClick={() => onOpenMedia && onOpenMedia()} className="w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 bg-primary text-white rounded-md shadow-sm hover:bg-primary/90 transition-colors">
                Urunler
              </button>
            </div>
            <div className="flex gap-2 w-full sm:w-auto">
              <button onClick={() => onExportPdf(data.id)} title="PDF indir" aria-label="Raporu PDF olarak disa aktar" className="flex-1 sm:flex-auto px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                <DocumentArrowDownIcon className="w-5 h-5 mx-auto" />
              </button>
              <button onClick={onEdit} aria-label="Cocuk profilini duzenle" className="flex-1 sm:flex-auto px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                Duzenle
              </button>
              <button onClick={onRefreshInsights} aria-label="Yapay Zeka analizini yenile" className="flex-1 sm:flex-auto px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
              <button onClick={onRefreshInsights} aria-label={"Yapay Zekâ analizini yenile"} className="flex-1 sm:flex-auto px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* 2. Istatistik Bari */}
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-2 px-4 sm:px-0">
        <StatCard label="Toplam GÃ¶zlem" value={data.stats?.observations ?? 'â€”'} onClick={() => onOpenObservations && onOpenObservations()} />
        <StatCard label={"Toplam Gözlem"} value={data.stats?.observations ?? "—"} onClick={() => onOpenObservations && onOpenObservations()} />
        <StatCard label={"Ürün/Medya Sayýsý"} value={data.stats?.products ?? "—"} onClick={() => onOpenMedia && onOpenMedia()} />
        <StatCard label={"Son Gözlem"} value={formatDate(data.lastObservationAt)} />
      {/* YumuÅŸak ayrÄ±m iÃ§in gradient */}
      <div className="h-4 bg-gradient-to-b from-gray-100 to-transparent rounded-b-lg mb-6" />
    </div>
  );
};interface ChildDetailScreenProps {
  childId: string;
  navigate: (page: string, params?: any) => void;
}

const ChildDetailScreen: React.FC<ChildDetailScreenProps> = ({ childId, navigate }) => {
  const { user } = useAuth();
  const [profileData, setProfileData] = useState<ChildProfileData | null>(null);
  const [child, setChild] = useState<Child | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [isRefreshingInsights, setIsRefreshingInsights] = useState(false);

  const getErrorMessage = (error: unknown): string => {
    if (error instanceof Error) return error.message;
    return "Bilinmeyen bir hata oluÅŸtu.";
  };

  const fetchData = useCallback(async () => {
    if (!user) return;
    try {
      setLoading(true);
      setError(null);

      const { data: childData, error: childError } = await supabase.from('children').select('*').eq('id', childId).single();
      if (childError || !childData) throw childError || new Error(t('childNotFound'));
      setChild(childData);

      const observations = await getObservationsForChild(childId);
      const media = await getMediaForChild(childId);
      
      const assessments = observations.map(o => o.assessments).filter(Boolean) as Assessment[];
      const riskLevels = assessments.map(a => a.risk);
      const overallRisk: Risk = riskLevels.includes('high') ? 'high' : riskLevels.includes('medium') ? 'medium' : 'low';
      
      const lastObservation = observations.length > 0 ? observations[0] : null;

      // Build AI insights dynamically from latest assessments' suggestions
      const latestAssessments = (assessments || []).slice(0, 3);
      const insightSet = new Set<string>();
      for (const a of latestAssessments) {
        if (Array.isArray(a.suggestions)) {
          for (const s of a.suggestions) {
            if (typeof s === 'string' && s.trim()) insightSet.add(s.trim());
          }
        }
      }
      const dynamicInsights = Array.from(insightSet).slice(0, 5);

      const data: ChildProfileData = {
        id: childData.id,
        firstName: childData.first_name,
        lastName: childData.last_name,
        dob: childData.dob,
        classroom: childData.classroom,
        photoUrl: childData.photo_url,
        consentObtained: childData.consent_obtained,
        enrolledAt: childData.created_at,
        lastObservationAt: lastObservation?.created_at,
        stats: {
          observations: observations.length,
          products: media.length,
          risk: overallRisk,
        },
        guardians: childData.guardians || [],
        health: childData.health || { allergies: [], notes: '' },
        interests: childData.interests || [],
        strengths: childData.strengths || [],
        aiInsights: dynamicInsights,
      };

      setProfileData(data);

    } catch (e: unknown) {
      setError(getErrorMessage(e));
    } finally {
      setLoading(false);
    }
  }, [childId, user]);

  useEffect(() => {
    fetchData();
    window.addEventListener('datachanged', fetchData);
    return () => window.removeEventListener('datachanged', fetchData);
  }, [fetchData]);
  
    
    const handleExportPdf = async (id: string) => {
      try {
        let childData: any | null = null;
        if (child && child.id === id) {
          childData = child;
        } else {
          const { data, error } = await supabase.from('children').select('*').eq('id', id).single();
          if (error || !data) throw error || new Error(t('childNotFound'));
          childData = data;
        }
        const observations = await getObservationsForChild(id);
        const mediaRaw = await getMediaForChild(id);
        const mediaWithUrls = await Promise.all((mediaRaw || []).map(async (m: any) => {
          try { const url = await getSignedUrlForMedia(m.storage_path, 3600); return { ...m, url }; } catch { return m; }
        }));
        await generatePdf(childData as any, observations as any, mediaWithUrls as any, `${user?.user_metadata?.first_name ?? ""} ${user?.user_metadata?.last_name ?? ""}`.trim(), user?.user_metadata?.school_name ?? "");
      } catch (e: any) {
        console.error(e);
        alert(e?.message || t('errorOccurred'));
      }
  };

  const handleChangePhoto = async (file: File) => {
    if (!child || !user) return;
    try {
      setIsSaving(true);
      const url = await uploadChildPhoto(user.id, child.id, file);
      await updateChild(child.id, { photo_url: url });
    } catch (e) {
      console.error(e);
      alert(t('errorOccurred'));
    } finally {
      setIsSaving(false);
    }
  };

  const handleRefreshInsights = async () => {
    if (!user) return;
    try {
      setIsRefreshingInsights(true);
      const obs = await getObservationsForChild(childId);
      const serverObs = (obs as any[]).filter(o => !(o as any).dirty);

      // Recompute for observations missing assessment OR having fallback summary
      const toRecompute = serverObs.filter((o: any) => {
        if (!o.assessments) return true;
        const sum = String(o.assessments.summary || '');
        return sum.startsWith('Bu, yapay zeka servisi');
      });

      const insightSet = new Set<string>();
      let created = 0;
      for (const o of toRecompute) {
        try {
          const analysis = await getAiAnalysis(o.note, o.domains as any);
          // update UI insights immediately (best-effort)
          if (Array.isArray(analysis.suggestions)) {
            for (const s of analysis.suggestions) {
              if (typeof s === 'string' && s.trim()) insightSet.add(s.trim());
            }
          }
          // persist to DB (best-effort with upsert)
          await addAssessmentForObservation(o.id, user.id, {
            summary: analysis.summary,
            risk: analysis.risk as any,
            suggestions: analysis.suggestions || [],
            domain_scores: analysis.domain_scores as any,
          });
          created++;
        } catch (err) {
          console.error('AI recompute failed for observation', o.id, err);
        }
      }

      // If we collected fresh insights, reflect them immediately
      if (insightSet.size > 0 && profileData) {
        const updated = { ...profileData, aiInsights: Array.from(insightSet).slice(0, 5) };
        setProfileData(updated);
      }

      // Also refetch to rebuild stats + latest persisted assessments
      await fetchData();
    } finally {
      setIsRefreshingInsights(false);
    }
  };

  const handleUpdateChild = async (updates: Partial<Child>) => {
    if (!child) return;
    setIsSaving(true);
    setError(null);
    try {
        await updateChild(child.id, updates);
        setIsEditModalOpen(false);
    } catch(e: unknown) {
        setError(getErrorMessage(e));
    } finally {
        setIsSaving(false);
    }
  };


  if (loading) return <p>{t('loading')}</p>;
  if (error) return <p className="text-red-500 my-4 bg-red-100 p-3 rounded-md">{error}</p>;
  if (!profileData) return <p>{t('childNotFound')}</p>;

  return (
    <>
      <ChildProfileCard
        data={profileData}
        onAddObservation={() => navigate('add-observation', { childId })}        onExportPdf={handleExportPdf}
        onEdit={() => setIsEditModalOpen(true)}
        onChangePhoto={handleChangePhoto}
        onRefreshInsights={handleRefreshInsights}
        onOpenMedia={() => navigate('media', { childId })}
          onOpenObservations={() => navigate('child-observations', { childId })}
      />
      {/* Alt Bilgiler: Temel, Veli, Saglik, Ilgi/Guclu, AI Ongoruler */}
      {/* Alt Bilgiler: Temel, Veli, Saðlýk, Ýlgi/Güçlü, AI Öngörüleri */}
        {/* Sol Kolon */}
        <div className="lg:col-span-5 flex flex-col gap-6">
          <Section title="Temel Bilgiler" onEdit={() => setIsEditModalOpen(true)}>
          <Section title={"Temel Bilgiler"} onEdit={() => setIsEditModalOpen(true)}>
              <InfoRow label="Ad Soyad" value={`${profileData.firstName} ${profileData.lastName}`} />
              <InfoRow label="Dogum Tarihi" value={formatDate(profileData.dob)} />
              <InfoRow label={"Doðum Tarihi"} value={formatDate(profileData.dob)} />
              <InfoRow label={"Yaþ"} value={calculateAge(profileData.dob)} />
              <InfoRow label={"Sýnýf"} value={profileData.classroom} />
              <InfoRow label={"Kayýt Tarihi"} value={formatDate(profileData.enrolledAt)} />
          </Section>
          <Section title="Ilgi Alanlari">
          <Section title={"Ýlgi Alanlarý"}>
          </Section>
          <Section title="Guclu Yonler">
          <Section title={"Güçlü Yönler"}>
          </Section>
        </div>
        {/* Sag Kolon */}
        <div className="lg:col-span-7 flex flex-col gap-6">
        <div className="lg:col-span-7 flex flex-col gap-6">
          <Section title={"Veli ve Ýletiþim Bilgileri"}>
              <div className="space-y-3">
                {profileData.guardians.map((g, i) => <GuardianCard key={i} guardian={g} />)}
              </div>
            ) : (
              <p className="text-sm text-gray-500 italic">Veli bilgisi eklenmemis.</p>
              <p className="text-sm text-gray-500 italic">Veli bilgisi eklenmemiþ.</p>
          </Section>
          <Section title="Saglik Bilgileri">
          <Section title={"Saðlýk Bilgileri"}>
              <div>
                <h4 className="font-semibold text-gray-700">Alerjiler</h4>
                <TagList tags={(profileData.health?.allergies as any) || []} />
              </div>
              <div>
                <h4 className="font-semibold text-gray-700">Onemli Notlar</h4>
                <h4 className="font-semibold text-gray-700">Önemli Notlar</h4>
                <p className="text-sm text-gray-600 mt-1">{profileData.health?.notes || "—"}</p>
            </div>
          </Section>
          <Section title="Yapay Zeka Ongoruleri">
          <Section title={"Yapay Zekâ Öngörüleri"}>
              <ul className="list-disc list-inside space-y-2 text-sm text-gray-700">
                {profileData.aiInsights.map((insight, i) => <li key={i}>{insight}</li>)}
              </ul>
            ) : (
              <p className="text-sm text-gray-500 italic">Analiz edilecek yeterli gozlem yok.</p>
              <p className="text-sm text-gray-500 italic">Analiz edilecek yeterli gözlem yok.</p>
          </Section>
        </div>
      </div>
       {isEditModalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4" onClick={() => setIsEditModalOpen(false)}>
            <div className="w-full max-w-2xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <ChildForm 
                    formTitle={t('editChild')}
                    initialData={child}
                    isSaving={isSaving}
                    onSave={handleUpdateChild}
                    onCancel={() => setIsEditModalOpen(false)}
                />
            </div>
        </div>
        )}
    </>
  );
};

export default ChildDetailScreen;



















